<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title>Vibrant Web</title>
    <script type="text/javascript" src='js/jquery-1.6.4.min.js'></script>
    <script type="text/javascript" src='js/jquery.tablesorter.min.js'></script>
    <script type="text/javascript" src='js/jstorage.js'></script>
    <script type="text/javascript" src='js/utils.js'></script>
    <link rel="stylesheet" href="css/blue/style.css" />
    <link rel="stylesheet" href="css/leaderboard.css" />
  </head>

<body>
	<div id="main">
		<div id="trigger"></div>
		<div id="settings" class="clearfix">
			
			<div id="controls">
				<div id="onOff">
					<div class='button' id="sessionOff">OFF</div>
					<div class='button' id="sessionOn">ON</div>
				</div>
				<div id="clearHistory">clear history</div>
			</div>
			<div id="title">The Vibrant Web</div>
			
		</div>
		<div id="leaderboard">
		
		
		</div>
		<div id="footer">
			<span>Sites visited since </span>
			<span id="since_date"></span>
			<span>: </span>
			<span id="count_sites"></span>
		</div>
	
	
	
	
	</div>
	
	
	<script type="text/javascript">
		var btns = {
			sessionOn: {
				val:true
			},
			sessionOff: {
				val:false
			}
		}
		
		
		
	
		chrome.extension.sendRequest({method:"get",dataLabel:"sessionState"}, function(response) {
			console.log(response.method);
			console.log(response.data["sessionOn"]);
			if (response.data["sessionOn"]) {
				$("#sessionOn").addClass("selected");
				$("#sessionOff").addClass("de-selected");
			} else {
				$("#sessionOff").addClass("selected");
				$("#sessionOn").addClass("de-selected");
			}
			
		});
	
	
	
		$(".button").click(function(){
			$(this).removeClass("de-selected").addClass("selected");
			$(this).siblings().removeClass("selected").addClass("de-selected");
			var val = btns[$(this).attr('id')].val;
	    	chrome.extension.sendRequest({method:"set",dataLabel:"sessionState",data:{"sessionOn":val}}, function(response) {
				console.log(response.method);
				console.log(response.data);
			});
		});
		
		$("#clearHistory").click(function() {
			chrome.extension.sendRequest({method:"delete",dataLabel:"browsingData"}, function(response) {
				$("#myTable > tbody").remove();
			});	
		})
		
		$("#title").click(function(){
			chrome.tabs.create({url:chrome.extension.getURL('landingpage.html')});
			window.close();
		})

		
		function viewDataAsTable(_data,tabDomain) {
			var total_sites = Object.keys(_data.sites).length;
			$("#count_sites").text(total_sites);			
			$("#since_date").text(_data.oldest_timestamp.split("T")[0]+" "+_data.oldest_timestamp.split("T")[1].split(".")[0]);
			
			
			var str="<table id='myTable' class='tablesorter'><thead><tr>";	
			str+="<th class='this_th'></th><th class='domain_head'>Domain</th><th class='count_head'>Count</th><th class='count_head'>Sites</th>";
			str+="</tr></thead><tbody>";
		
			$.each(_data.entities,function(k,v){
					console.log("tab",tabDomain,v.sites);
					var highlight_td = "color_off";
					var highlight_on = 1;
					if (v.sites.indexOf(tabDomain)!=-1){
						highlight_td = "color_on";
						highlight_on = 0;
					}
					str+="<tr><td width='15' class='"+highlight_td+"'>"+highlight_on+"</td>"
					+"<td class='domain_td'><a target='_blank' href='http://www.whois.net/whois/"+parseBaseDomain(k)+"'>"+k+"</a></td>"
					+"<td align='center' width='48' class='count_td'>"+v.sites.length+"</td>"
					+"<td align='center' width='48' class='count_td'>"+Math.round(v.sites.length/total_sites*100)+"%"+"</td></tr>";
			})
			str+="</tbody></table>";
			
			return str;
		}
		
		console.log("starting send request");
		
		chrome.extension.sendRequest({method:"get",dataLabel:"browsingData",sort_type:"by_domain"}, function(response) {
			var _data = response.data;
			var len = Object.keys(_data).length;
			if (!(len>0)) {
				$('#leaderboard').append("<div id='noResults'>You currently have no Vibrant history.</div>");
			} else {
				chrome.tabs.getSelected(null,function(tab) {
					console.log("tab url",tab.url);
					var tabDomain = parseBaseDomainFromLink(tab.url,true);
					var table = viewDataAsTable(_data,tabDomain);
					$('#leaderboard').append(table);
			    	$("#myTable").tablesorter({sortList: [[2,1]] });

				});
			}
		
		});

	
	</script>
</body>
</html>
