<html>
<head>
    <script type="text/javascript" src='jquery-1.6.4.min.js'></script>
    <script type="text/javascript" src='jstorage.js'></script>
    <script type="text/javascript" src='utils.js'></script>
  </head>
<script type="text/javascript">
	
	function getLocalDataObj(dataLabel,obj) {
		var _data = obj;
		if ($.jStorage.index().indexOf(dataLabel)!=-1&&typeof($.jStorage.get(dataLabel))!='undefined'){
    		_data = $.jStorage.get(dataLabel);    		
    	}
    	return _data;
	}
	
	var dataTypes = {
		browsingData: {
			obj: {"entities":[]},
			update: function(_obj,_data) {
				_obj["entities"] = _obj["entities"].concat(_data);
				return _obj;
			}
		},
		sessionState: {
			obj: {"sessionOn":true},
			update: function(_obj,_data) {
				_obj["sessionOn"] = _data["sessionOn"];
			}
		}
	}
	
	chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
    	//console.log(sender.tab ? "from a content script:" + sender.tab.url :"from the extension");
    	
    	switch(request.method) {
    		case 'get':
    			var _obj = getLocalDataObj(request.dataLabel,dataTypes[request.dataLabel].obj);
	    		sendResponse({method:"getting",data:_obj})
	    		break;
	    	
	    	case 'set':
    			var _obj = getLocalDataObj(request.dataLabel,dataTypes[request.dataLabel].obj);
    			_obj = dataTypes[request.dataLabel].update(_obj,request.data);	    		
	    		$.jStorage.set(request.dataLabel,_obj);
	    		var size = $.jStorage.storageSize();
	    		sendResponse({method:"setting",data:_obj,size:toMBytes(size)});
				break;
				
			case 'delete':
				$.jStorage.deleteKey(request.dataLabel);
	    		var size = $.jStorage.storageSize();
	    		sendResponse({method:"deleting",size:toMBytes(size)});
				break;	
    	}

 	});

</script>
</html>