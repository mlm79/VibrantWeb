<html>
<head>
    <script type="text/javascript" src='js/jquery-1.6.4.min.js'></script>
    <script type="text/javascript" src='js/jstorage.js'></script>
    <script type="text/javascript" src='js/utils.js'></script>
  </head>
<script type="text/javascript">
	
	/* 
	getDataShell function
	
	@params: dataLabel - string, name of data object in local storage
			returnType - dataType[dataLabel] property to be returned
			
	Defines the kinds of data stored locally. Label for data object => data object structure, update function for adding data to object.
	
	TO DO: add function for deleting data; e.g. when space runs out, delete old data.
	*/
	
	function getDataShell(_dataLabel,returnType) {
		var dataTypes = {
			browsingData: {
				obj: {"entities":[]},
				update: function(_obj,_data) {
					_obj["entities"] = _obj["entities"].concat(_data);
					return _obj;
				}
			},
			sessionState: {
				obj: {"sessionOn":false},
				update: function(_obj,_data) {
					_obj["sessionOn"] = _data["sessionOn"];
					return _obj;
				}
			}
		}
		return dataTypes[_dataLabel][returnType];
	}
	
	/* 
	getLocalDataObj function
	
	@params: dataLabel - string, name of data object in local storage
	
	Get either the stored data object, or the empty shell, e.g. {"entities":[]}
	
	*/
	
	function getLocalDataObj(dataLabel) {
		var _data = getDataShell(dataLabel,'obj');;
		if ($.jStorage.index().indexOf(dataLabel)!=-1&&typeof($.jStorage.get(dataLabel))!='undefined'){
    		_data = $.jStorage.get(dataLabel);  		
    	} 
    	return _data;
	}
	
	/* 
	setLocalDataObj function
	
	@params: dataLabel - string, name of data object in local storage
			new_data - array of entities from current web session, sent via request object
	
	Update and set the local storage object
	
	*/
	
	function setLocalDataObj(dataLabel,new_data) {
		var data = getLocalDataObj(dataLabel);
		var updateFunc = getDataShell(dataLabel,'update');
		$.jStorage.set(dataLabel,updateFunc(data,new_data));
	}

		
	/* 
	chrome.extension.onRequest.addListener function
	
	@params: sender - object, where the request originated from
			 request - obejct, the message sent
			 sendResponse - function, takes object to be returned to sender
	
	Listens to both web site actions (via vibrant_new.js) and popup.html actions. Provides functions for
	getting, setting, and updating local data storage.
	*/
	
	chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
    	//console.log(sender.tab ? "from a content script:" + sender.tab.url :"from the extension");  
    	
    	switch(request.method) {
    		case 'get':
				//Nothing happens in here; all methods get the final object and pass it back to the browser
	    		break;
	    	
	    	case 'set':   
    			setLocalDataObj(request.dataLabel,request.data);		
				break;
				
			case 'delete':
				$.jStorage.deleteKey(request.dataLabel);
				break;	
    	}
    	
    	var _obj = getLocalDataObj(request.dataLabel);
    	var size = $.jStorage.storageSize();
	    sendResponse({method:request.method,data:_obj,size:toMBytes(size)});
  
 	});

</script>
</html>