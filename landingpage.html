<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
	<head>
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<script type="text/javascript" src='js/jquery-1.6.4.min.js'></script>
		<script type="text/javascript" src='js/jquery.tablesorter.min.js'></script>
	    <script type="text/javascript" src='js/utils.js'></script>
	   	<script type="text/javascript" src='js/vibrant_new.js'></script>
	   	<script type="text/javascript" src='js/Three.js'></script>
	   	<link rel="stylesheet" href="css/blue/style.css" />
	   	<link rel="stylesheet" href="css/landingpage.css" />
	</head>
	<body>
			   	<script src="js/RequestAnimationFrame.js"></script>

	 	<script type="text/javascript">
	 	
	 		var response = {};
	 		
	 		var entityColors = {
	 			"scripts":0x3a1d5c,
	 			"links":0xba3c88,
	 			"cookies":0x00ffd0,
	 			"images":0xbfd470,
	 			"frames":0xF0AF66		
	 		}
	 		
	 		function webgl_test(entities,entityColors){
	 		var container;

			var camera, scene, renderer;
			var cameraCube, sceneCube, cubeTarget;

			var mesh, zmesh, lightMesh, geometry;
			var spheres = [];

			var directionalLight, pointLight;

			var mouseX = 0, mouseY = 0;

			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;

			document.addEventListener( 'mousemove', onDocumentMouseMove, false );

			init();
			animate();

			function init() {

				container = document.createElement( 'div' );
				document.body.appendChild( container );

				camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 100000 );
				camera.position.z = 3200;

				cameraCube = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 100000 );

				cubeTarget = new THREE.Vector3( 0, 0, 0 );

				scene = new THREE.Scene();
				sceneCube = new THREE.Scene();

				var geometry = new THREE.SphereGeometry( 100, 32, 16 );
				
				//backgroundImage

				var path = chrome.extension.getURL('landingpage.html')+"/../imgs/test4/";
				var format = '.gif';
				var urls = [
					path + 'px' + format, path + 'nx' + format,
					path + 'py' + format, path + 'ny' + format,
					path + 'pz' + format, path + 'nz' + format
				];

				var textureCube = THREE.ImageUtils.loadTextureCube( urls, new THREE.CubeRefractionMapping() );
				//var material = new THREE.MeshBasicMaterial( { color: 0xffffff, envMap: textureCube, refractionRatio: 0.95 } );

				for ( var i = 0; i < entities.length; i ++ ) {
					//entityColors[entities['type']]
					console.log(entities[i]['type']);

					var material = new THREE.MeshBasicMaterial( { color: entityColors[entities[i]['type']], envMap: textureCube, refractionRatio: 0.95 } );
					var mesh = new THREE.Mesh( geometry, material );

					mesh.position.x = Math.random() * 10000 - 5000;
					mesh.position.y = Math.random() * 10000 - 5000;
					mesh.position.z = Math.random() * 10000 - 5000;

					mesh.scale.x = mesh.scale.y = mesh.scale.z = Math.random() * 3 + 1;

					scene.add( mesh );

					spheres.push( mesh );

				}

				// Skybox

				var shader = THREE.ShaderUtils.lib[ "cube" ];
				shader.uniforms[ "tCube" ].texture = textureCube;

				var material = new THREE.ShaderMaterial( {

					fragmentShader: shader.fragmentShader,
					vertexShader: shader.vertexShader,
					uniforms: shader.uniforms,
					depthWrite: false

				} ),

				mesh = new THREE.Mesh( new THREE.CubeGeometry( 100, 100, 100 ), material );
				mesh.flipSided = true;
				sceneCube.add( mesh );

				//

				renderer = new THREE.WebGLRenderer();
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.autoClear = false;
				container.appendChild( renderer.domElement );

			}

			function onDocumentMouseMove(event) {

				mouseX = ( event.clientX - windowHalfX ) * 10;
				mouseY = ( event.clientY - windowHalfY ) * 10;

			}

			//

			function animate() {

				requestAnimationFrame( animate );

				render();

			}

			function render() {

				var timer = 0.0001 * Date.now();

				camera.position.x += ( mouseX - camera.position.x ) * .05;
				camera.position.y += ( - mouseY - camera.position.y ) * .05;

				camera.lookAt( scene.position );

				cubeTarget.x = - camera.position.x;
				cubeTarget.y = - camera.position.y;
				cubeTarget.z = - camera.position.z;

				cameraCube.lookAt( cubeTarget );

				for ( var i = 0, il = spheres.length; i < il; i ++ ) {

					var sphere = spheres[ i ];

					sphere.position.x = 5000 * Math.cos( timer + i );
					sphere.position.y = 5000 * Math.sin( timer + i * 1.1 );

				}

				renderer.clear();
				renderer.render( sceneCube, cameraCube );
				renderer.render( scene, camera );

			}
	 		}
	 		
	 		
	 		
	 		chrome.extension.sendRequest({method:"get",dataLabel:"browsingData"}, function(response) {
	 			var entities = response.data.entities
	 			if (entities.length>0) {


					webgl_test(entities,entityColors);

	 			
	 			
	 			
	 				
	 				//var table = Vibrant.viewDataAsTable(entities);
	    			//$('body').append(table);
	    			//$("#myTable").tablesorter();
	    			
	    		} else {
	    			$('body').append("<div id='noResults'>You currently have no Vibrant history.</div>");
	    		}
	 		
	 		});
	 		
	    </script>
	
	
	</body>
</html>